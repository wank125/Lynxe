import{E as O,r as v,c as G,_ as le,$ as B}from"./index-WjMAoR12.js";import{P as I}from"./plan-template-with-tool-api-service-mLh5z1Zw.js";class oe{isCollapsed=!1;currentTab="list";toggleSidebar(){this.isCollapsed=!this.isCollapsed}switchToTab(a){this.currentTab=a}}const he=O(new oe);function ne(){const t=O({title:"",steps:[],planType:"dynamic_agent",planTemplateId:"",accessLevel:"editable",serviceGroup:""}),a=v(!1),l=v(null),n=v(!1),d=v(!1),r=v([]),s=v(-1),i=v([]),c=v(null),T=v(null),C=()=>t.title,S=()=>t.planType||"dynamic_agent",b=()=>t.serviceGroup||"",j=e=>{t.title=e},_=e=>{t.steps=e||[]},x=e=>{t.planType=e},H=e=>{t.planTemplateId=e},U=e=>{t.serviceGroup=e},A=e=>{e===void 0?delete t.toolConfig:t.toolConfig=e},E=e=>{t.toolConfig||(t.toolConfig={}),t.toolConfig.toolDescription=e},k=e=>{t.toolConfig||(t.toolConfig={}),t.toolConfig.enableInternalToolcall=e},z=e=>{t.toolConfig||(t.toolConfig={}),t.toolConfig.enableHttpService=e},W=e=>{t.toolConfig||(t.toolConfig={}),t.toolConfig.enableInConversation=e},N=e=>{t.toolConfig||(t.toolConfig={}),t.toolConfig.inputSchema=e||[]},y=()=>({...t}),w=e=>{d.value=!0;const o=e.accessLevel||(e.readOnly?"readOnly":"editable"),u={title:e.title||"",steps:(e.steps||[]).map(g=>({...g,selectedToolKeys:g.selectedToolKeys??[]})),planType:e.planType||"dynamic_agent",planTemplateId:e.planTemplateId||"",accessLevel:o,serviceGroup:e.serviceGroup||""};e.version!==void 0&&(u.version=e.version),e.toolConfig&&(u.toolConfig={...e.toolConfig}),Object.assign(t,u),setTimeout(()=>{d.value=!1},50)},$=()=>{d.value=!0,Object.assign(t,{title:"",steps:[],planType:"dynamic_agent",planTemplateId:"",accessLevel:"editable",serviceGroup:"",version:void 0}),"toolConfig"in t&&delete t.toolConfig,r.value=[],s.value=-1,l.value=null,setTimeout(()=>{d.value=!1},0)},K=()=>{const e=t.accessLevel||(t.readOnly?"readOnly":"editable"),o={title:t.title||"",steps:(t.steps||[]).map(u=>({...u,selectedToolKeys:u.selectedToolKeys??[]})),planType:t.planType||"dynamic_agent",planTemplateId:t.planTemplateId||"",accessLevel:e,serviceGroup:t.serviceGroup||""};return t.version!==void 0&&(o.version=t.version),t.toolConfig&&(o.toolConfig={...t.toolConfig}),JSON.stringify(o,null,2)},M=e=>{try{const o=JSON.parse(e);return w(o),!0}catch(o){return l.value=o instanceof Error?o.message:"Invalid JSON format",!1}},q=G(()=>r.value.length>1&&s.value>0),F=G(()=>r.value.length>1&&s.value<r.value.length-1),Q=()=>{if(q.value&&s.value>0){s.value--;const e=r.value[s.value]||"";M(e)}},X=()=>{if(F.value&&s.value<r.value.length-1){s.value++;const e=r.value[s.value]||"";M(e)}},Y=e=>{s.value<r.value.length-1&&(r.value=r.value.slice(0,s.value+1)),r.value.push(e),s.value=r.value.length-1},R=async e=>{if(!e)return l.value="Plan template ID is required",!1;try{a.value=!0,l.value=null;const o=await I.getPlanTemplateConfigVO(e);T.value===e&&(T.value=null,await new Promise(g=>setTimeout(g,0))),n.value=!1,w(o),T.value=e,await new Promise(g=>setTimeout(g,10)),c.value?.planTemplateId===e&&(c.value={...c.value,...o});try{const g=await le.getPlanVersions(e);r.value=g.versions||[],r.value.length>0?s.value=r.value.length-1:s.value=-1}catch(g){console.warn("Failed to load plan versions:",g),r.value=[],s.value=-1}return!0}catch(o){return l.value=o instanceof Error?o.message:"Failed to load plan template config",console.error("Failed to load plan template config:",o),!1}finally{a.value=!1}},Z=async()=>{if(!t.planTemplateId)return l.value="Plan template ID is required",!1;try{a.value=!0,l.value=null;const e=await I.createOrUpdatePlanTemplateWithTool(y());if(e.success){const o=e.planTemplateId||t.planTemplateId;if(o&&o!==t.planTemplateId&&(console.log("[usePlanTemplateConfig] PlanTemplateId replaced by backend:",t.planTemplateId,"->",o),t.planTemplateId=o),o){await R(o);const u=c.value?.planTemplateId;if(u===o||u===t.planTemplateId){const f=y();c.value={...c.value,...f,planTemplateId:o}}const g=i.value.findIndex(f=>f.planTemplateId===o||f.planTemplateId===u);if(g>=0){const f=y();i.value[g]={...i.value[g],...f,planTemplateId:o}}else if(u){const f=i.value.findIndex(D=>D.planTemplateId===u);if(f>=0){const D=y();i.value[f]={...i.value[f],...D,planTemplateId:o}}}}}return e.success}catch(e){return l.value=e instanceof Error?e.message:"Failed to save plan template config",console.error("Failed to save plan template config:",e),!1}finally{a.value=!1}},V=()=>{const e=[];return t.planTemplateId?.trim()||e.push("Plan template ID is required"),t.title?.trim()||e.push("Title is required"),(!t.steps||t.steps.length===0)&&e.push("At least one step is required"),{isValid:e.length===0,errors:e}},ee=e=>e?Array.isArray(e)&&e.length>=6?new Date(e[0],e[1]-1,e[2],e[3],e[4],e[5],Math.floor(e[6]/1e6)):typeof e=="string"?new Date(e):new Date:new Date,te=()=>{const e=[];for(const o of i.value){if(!o.toolConfig)continue;const u=o.toolConfig;if(!u.enableInternalToolcall)continue;let g="[]";u.inputSchema&&Array.isArray(u.inputSchema)&&(g=JSON.stringify(u.inputSchema));const f={toolName:o.title||"",toolDescription:u.toolDescription||"",planTemplateId:o.planTemplateId||"",inputSchema:g,enableInternalToolcall:u.enableInternalToolcall??!0,enableHttpService:u.enableHttpService??!1,enableInConversation:u.enableInConversation??!1};o.serviceGroup&&(f.serviceGroup=o.serviceGroup),e.push(f)}return e},ae=()=>i.value.some(e=>e.toolConfig!==void 0),h=e=>{n.value=!0;try{return e()}finally{setTimeout(()=>{n.value=!1},0)}};return{config:t,isLoading:a,error:l,isUserUpdating:n,needsFullRefresh:d,planVersions:r,currentVersionIndex:s,planTemplateList:i,selectedTemplate:c,currentPlanTemplateId:T,getTitle:C,getPlanType:S,getServiceGroup:b,getConfig:y,setTitle:j,setSteps:_,setPlanType:x,setPlanTemplateId:H,setServiceGroup:U,setToolConfig:A,setToolDescription:E,setEnableInternalToolcall:k,setEnableHttpService:z,setEnableInConversation:W,setInputSchema:N,setConfig:w,setStepsWithGuard:e=>h(()=>{_(e)}),setToolConfigWithGuard:e=>h(()=>{A(e)}),setToolDescriptionWithGuard:e=>h(()=>{E(e)}),setEnableInternalToolcallWithGuard:e=>h(()=>{k(e)}),setEnableHttpServiceWithGuard:e=>h(()=>{z(e)}),setEnableInConversationWithGuard:e=>h(()=>{W(e)}),setInputSchemaWithGuard:e=>h(()=>{N(e)}),withUpdateGuard:h,reset:$,load:R,save:Z,validate:V,generateJsonString:K,fromJsonString:M,rollbackVersion:Q,restoreVersion:X,updateVersionsAfterSave:Y,canRollback:q,canRestore:F,parseDateTime:ee,getAllCoordinatorToolsFromTemplates:te,getCoordinatorToolConfig:ae}}let P=null;function J(){return P||(P=ne()),P}class se{isLoading=!1;errorMessage="";hasTaskRequirementModified=!1;organizationMethod="by_group_time";templateServiceGroups=new Map;groupCollapseState={};constructor(){const a=localStorage.getItem("sidebarOrganizationMethod");a&&["by_time","by_abc","by_group_time","by_group_abc"].includes(a)&&(this.organizationMethod=a),this.loadGroupCollapseState()}loadGroupCollapseState(){try{const a=localStorage.getItem("sidebarGroupCollapseState");if(a){const l=JSON.parse(a);this.groupCollapseState=l||{}}}catch(a){console.warn("[TemplateStore] Failed to load group collapse state:",a)}}saveGroupCollapseState(){try{localStorage.setItem("sidebarGroupCollapseState",JSON.stringify(this.groupCollapseState))}catch(a){console.warn("[TemplateStore] Failed to save group collapse state:",a)}}toggleGroupCollapse(a){const l=a??"null",n=this.groupCollapseState[l]??!1;this.groupCollapseState[l]=!n,this.saveGroupCollapseState()}isGroupCollapsed(a){const l=a??"null";return this.groupCollapseState[l]??!1}parseDateTime(a){return a?Array.isArray(a)&&a.length>=6?new Date(a[0],a[1]-1,a[2],a[3],a[4],a[5],Math.floor(a[6]/1e6)):typeof a=="string"?new Date(a):new Date:new Date}templateConfig=J();setOrganizationMethod(a){this.organizationMethod=a,localStorage.setItem("sidebarOrganizationMethod",a)}async loadPlanTemplateList(){this.isLoading=!0,this.errorMessage="";try{console.log("[TemplateStore] Starting to load plan template list...");const a=await I.getAllPlanTemplateConfigVOs();this.templateConfig.planTemplateList.value=a,this.templateServiceGroups.clear();for(const l of this.templateConfig.planTemplateList.value){const n=l.planTemplateId;if(n){const d=l.serviceGroup||"";d&&this.templateServiceGroups.set(n,d)}}console.log(`[TemplateStore] Successfully loaded ${this.templateConfig.planTemplateList.value.length} plan templates`)}catch(a){console.error("[TemplateStore] Failed to load plan template list:",a),this.templateConfig.planTemplateList.value=[];const l=a instanceof Error?a.message:"Unknown error";this.errorMessage=`Load failed: ${l}`}finally{this.isLoading=!1}}async selectTemplate(a){this.templateConfig.currentPlanTemplateId.value=a.planTemplateId||null,this.templateConfig.selectedTemplate.value=a,this.hasTaskRequirementModified=!1,console.log(`[TemplateStore] Selected plan template: ${a.planTemplateId}`)}async createNewTemplate(a){try{const l=await I.generatePlanTemplateId();console.log("[TemplateStore] Generated plan template ID from backend:",l);const n={planTemplateId:l,title:B.global.t("sidebar.newTemplateName"),planType:a,createTime:new Date().toISOString(),updateTime:new Date().toISOString()};this.templateConfig.selectedTemplate.value=n,this.templateConfig.currentPlanTemplateId.value=null,this.hasTaskRequirementModified=!1,console.log("[TemplateStore] Created new empty plan template")}catch(l){console.error("[TemplateStore] Failed to generate plan template ID:",l);const n=`planTemplate-${Date.now()}`;console.warn("[TemplateStore] Using fallback plan template ID:",n);const d={planTemplateId:n,title:B.global.t("sidebar.newTemplateName"),planType:a,createTime:new Date().toISOString(),updateTime:new Date().toISOString()};this.templateConfig.selectedTemplate.value=d,this.templateConfig.currentPlanTemplateId.value=null,this.hasTaskRequirementModified=!1}}async deleteTemplate(a){const l=a.planTemplateId;if(!l){console.warn("[TemplateStore] deleteTemplate: Invalid template object or ID");return}try{await I.deletePlanTemplate(l),this.templateConfig.currentPlanTemplateId.value===l&&this.clearSelection(),await this.loadPlanTemplateList(),console.log(`[TemplateStore] Plan template ${l} has been deleted`)}catch(n){throw console.error("Failed to delete plan template:",n),await this.loadPlanTemplateList(),n}}clearSelection(){this.templateConfig.currentPlanTemplateId.value=null,this.templateConfig.selectedTemplate.value=null,this.hasTaskRequirementModified=!1}}const m=new se,re=J(),p=O({isLoading:m.isLoading,errorMessage:m.errorMessage,hasTaskRequirementModified:m.hasTaskRequirementModified,organizationMethod:m.organizationMethod,templateServiceGroups:m.templateServiceGroups,groupCollapseState:m.groupCollapseState,loadGroupCollapseState:()=>m.loadGroupCollapseState(),saveGroupCollapseState:()=>m.saveGroupCollapseState(),toggleGroupCollapse:t=>{m.toggleGroupCollapse(t);const a=t??"null";p.groupCollapseState[a]=m.groupCollapseState[a],p.groupCollapseState={...p.groupCollapseState}},isGroupCollapsed:t=>m.isGroupCollapsed(t),parseDateTime:t=>m.parseDateTime(t),setOrganizationMethod:t=>{m.setOrganizationMethod(t),p.organizationMethod=t},loadPlanTemplateList:async()=>{await m.loadPlanTemplateList(),p.isLoading=m.isLoading,p.errorMessage=m.errorMessage,p.templateServiceGroups=m.templateServiceGroups},selectTemplate:t=>m.selectTemplate(t),createNewTemplate:t=>m.createNewTemplate(t),deleteTemplate:t=>m.deleteTemplate(t),clearSelection:()=>m.clearSelection()}),L=G(()=>{const t=[...re.planTemplateList.value].filter(a=>(a.accessLevel||(a.readOnly?"readOnly":"editable"))!=="readOnly");switch(p.organizationMethod){case"by_time":return t.sort((a,l)=>{const n=p.parseDateTime(a.updateTime??a.createTime);return p.parseDateTime(l.updateTime??l.createTime).getTime()-n.getTime()});case"by_abc":return t.sort((a,l)=>{const n=(a.title??"").toLowerCase(),d=(l.title??"").toLowerCase();return n.localeCompare(d)});case"by_group_time":case"by_group_abc":{const a=new Map,l=[];t.forEach(s=>{const i=s.planTemplateId||"",c=p.templateServiceGroups.get(i)??"";!c||c==="default"||c===""?l.push(s):(a.has(c)||a.set(c,[]),a.get(c).push(s))});const n=new Map;a.forEach((s,i)=>{const c=[...s];p.organizationMethod==="by_group_time"?c.sort((T,C)=>{const S=p.parseDateTime(T.updateTime??T.createTime);return p.parseDateTime(C.updateTime??C.createTime).getTime()-S.getTime()}):c.sort((T,C)=>{const S=(T.title??"").toLowerCase(),b=(C.title??"").toLowerCase();return S.localeCompare(b)}),n.set(i,c)}),p.organizationMethod==="by_group_time"?l.sort((s,i)=>{const c=p.parseDateTime(s.updateTime??s.createTime);return p.parseDateTime(i.updateTime??i.createTime).getTime()-c.getTime()}):l.sort((s,i)=>{const c=(s.title??"").toLowerCase(),T=(i.title??"").toLowerCase();return c.localeCompare(T)});const d=[];return d.push(...l),Array.from(n.keys()).sort().forEach(s=>{d.push(...n.get(s))}),d}default:return t.sort((a,l)=>{const n=p.parseDateTime(a.updateTime||a.createTime||"");return p.parseDateTime(l.updateTime||l.createTime||"").getTime()-n.getTime()})}}),ie=G(()=>{if(p.organizationMethod!=="by_group_time"&&p.organizationMethod!=="by_group_abc")return new Map([[null,L.value]]);const t=new Map,a=[];L.value.forEach(r=>{const s=r.planTemplateId||"",i=p.templateServiceGroups.get(s)??"";!i||i==="default"||i===""?a.push(r):(t.has(i)||t.set(i,[]),t.get(i).push(r))});const n=new Map;return a.length>0&&n.set(null,a),Array.from(t.keys()).sort().forEach(r=>{n.set(r,t.get(r))}),n});Object.defineProperty(p,"sortedTemplates",{get:()=>L.value,enumerable:!0,configurable:!0});Object.defineProperty(p,"groupedTemplates",{get:()=>ie.value,enumerable:!0,configurable:!0});export{he as s,p as t,J as u};
//# sourceMappingURL=templateStore-Df_vNzZ_.js.map
